<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TI Calculator File Sender</title>
  <script src="https://cdn.jsdelivr.net/npm/ticalc-usb@latest/dist/index.js"></script>
</head>
<body>
  <h1>TI Calculator USB File Sender</h1>

  <div id="flow">
    <p><b>Supported devices:</b> <span id="supported"></span></p>
    <div class="buttons">
      <button id="connect">Connect Calculator</button>
      <select id="presetSelect" disabled><option value="">-- Select Preset --</option></select>
      <button id="start" disabled>Send Files</button>
    </div>
  </div>

  <div id="incompatible" style="display:none;">
    <p>Your browser does not support WebUSB.</p>
  </div>

  <div id="popup" class="popup" style="display:none; position: fixed; top: 30%; left: 50%; transform: translateX(-50%); background: #eee; padding: 1em; border: 1px solid #aaa;">
    <h2></h2>
    <p></p>
    <div class="buttons"></div>
  </div>

  <script>
    // Catch any synchronous error (runtime exceptions)
window.onerror = function(message, source, lineno, colno, err) {
  alert(`Error: ${message}\nSource: ${source}\nLine: ${lineno}, Column: ${colno}\nDetails: ${err ? err.stack : 'N/A'}`);
  // Return false to let the error propagate to the console as well
  return false;
};

// Catch unhandled rejected promises
window.addEventListener('unhandledrejection', function(event) {
  alert(`Unhandled promise rejection: ${event.reason ? event.reason.stack || event.reason : 'Unknown error'}`);
});

    const { ticalc, tifiles } = window["ticalc-usb"];
    let calculator = null;
    let preset = null;

    // Hardcoded presets of files (example URLs, replace with real URLs)
    const presets = [
      {
        name: "Just the jailbreak",
        files: [
          "./arTIfiCE_v2.8xp"
        ],
        info: "Go to PRGMs and run *A"
      },
      {
        name: "Jailbreak+Cesium",
        files: [
          "./arTIfiCE_v2.8xp",
          "./cesium_english.zx0.8xp"
        ],
        info: "Go to PRGMs and run *A, then select Cesium."
      }
    ];

    window.addEventListener('load', async () => {
      if (ticalc.browserSupported()) {
        showSupportedDevices();
        attachConnectionListeners();
        attachClickListeners();
        populatePresets();

        try {
          await ticalc.init({ supportLevel: 'none' });
        } catch (e) {
          handleUnsupported(e);
        }
        updateButtons();
        document.querySelector('#flow').style.display = 'block';
        document.querySelector('#incompatible').style.display = 'none';
      } else {
        document.querySelector('#flow').style.display = 'none';
        document.querySelector('#incompatible').style.display = 'block';
      }
    });

    function showSupportedDevices() {
      const calcNames = ticalc.models()
        .filter(c => c.status === 'supported' || c.status === 'beta')
        .map(c => c.status === 'beta' ? c.name + ' (beta)' : c.name)
        .join(', ');
      document.querySelector('#supported').innerText = calcNames || "None";
    }

    function updateButtons() {
      document.querySelector('#connect').disabled = !!calculator;
      document.querySelector('#presetSelect').disabled = !calculator;
      document.querySelector('#start').disabled = !(calculator && preset);
    }

    function attachConnectionListeners() {
      ticalc.addEventListener('disconnect', calc => {
        if (calc !== calculator) return;
        calculator = null;
        alert("Disconnected", "Calculator disconnected.");
        updateButtons();
      });

      ticalc.addEventListener('connect', async calc => {
        if (calc.status === 'experimental') {
          confirm('Be careful!', `Your device (${calc.name}) only has ${calc.status} support. Continue?`)
            .then(() => connect(calc))
            .catch(() => {});
        } else {
          await connect(calc);
        }
      });
    }

    async function connect(calc) {
      try {
        if (await calc.isReady()) {
          calculator = calc;
          alert('Connected', `Connected to ${calculator.name}.`);
          updateButtons();
        } else {
          alert('Error', 'The connected device is not responding.');
        }
      } catch (e) {
        alert('Connection Error', 'Failed to connect to device.');
        console.error(e);
      }
    }

    function attachClickListeners() {
      document.querySelector('#connect').addEventListener('click', async () => {
        try {
          await ticalc.choose();
        } catch (e) {
          handleUnsupported(e);
        }
      });

      const presetSelect = document.querySelector('#presetSelect');
      presetSelect.addEventListener('change', e => {
        const idx = e.target.value;
        if (idx !== "") {
          preset = presets[idx];
          //alert("Preset Selected", `You chose ${preset.name}.`);
        } else {
          preset = null;
        }
        updateButtons();
      });

      document.querySelector('#start').addEventListener('click', async () => {
        if (!calculator || !preset) return;

        for (const url of preset.files) {
          try {
            const response = await fetch(url);
            if (!response.ok) {
              alert('Download Error', `Failed to download file: ${url}`);
              return;
            }
            const buffer = await response.arrayBuffer();
            const file = tifiles.parseFile(new Uint8Array(buffer));

            if (!tifiles.isValid(file)) {
              alert('Invalid File', `Invalid calculator file: ${url}`);
              return;
            }
            if (!calculator.canReceive(file)) {
              alert('File Error', `File not valid for ${calculator.name}: ${url}`);
              return;
            }

            const details = await calculator.getStorageDetails(file);
            if (!details.fits) {
              alert('Memory Error', `Not enough memory on calculator for file: ${url}`);
              return;
            }

            await calculator.sendFile(file);
            console.log(`Sent: ${url}`);
          } catch (error) {
            alert(error);
            //alert('Send Error', `Failed to send file: ${url}`);
            return;
          }
        }
        document.querySelector('#start').disabled = true;
        alert('Next Steps', preset.info);
      });
    }

    function populatePresets() {
      const select = document.querySelector('#presetSelect');
      presets.forEach((p, i) => {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = p.name;
        select.appendChild(option);
      });
    }

    function handleUnsupported(error) {
      console.error(error);
      alert('Unsupported', error.message || 'Your calculator may not be supported yet.');
    }

    /* Popup system */
    function setPopup(title, body) {
      const popup = document.getElementById('popup');
      popup.querySelector('h2').innerText = title;
      popup.querySelector('p').innerText = body;
      popup.querySelector('.buttons').innerHTML = '';
      popup.style.display = 'block';
      return popup;
    }

    function popupButton(clss, text, fn) {
      const button = document.createElement('button');
      button.classList.add(clss);
      button.innerText = text;
      button.onclick = fn;
      return button;
    }

    async function alert(title, body) {
      return new Promise(resolve => {
        const popup = setPopup(title, body);
        const button = popupButton('yes', 'Okay', () => {
          popup.style.display = 'none';
          resolve();
        });
        popup.querySelector('.buttons').appendChild(button);
      });
    }

    async function confirm(title, body) {
      return new Promise((resolve, reject) => {
        const popup = setPopup(title, body);
        const yesButton = popupButton('yes', 'Okay', () => {
          popup.style.display = 'none';
          resolve();
        });
        const noButton = popupButton('no', 'Cancel', () => {
          popup.style.display = 'none';
          reject();
        });
        popup.querySelector('.buttons').appendChild(yesButton);
        popup.querySelector('.buttons').appendChild(noButton);
      });
    }
  </script>
</body>
</html>
